# 开发任务文档：资产表实现

## 概述

本文档描述了分镜师 V1.0 遗留功能的实现：角色表、场景表、道具表的展示和编辑功能。

**项目路径**: `D:\Users\user\Documents\Cursor\分镜师`

**技术栈**: Tauri + Vite + Vanilla JS

---

## 任务清单

1. [ ] 角色表（Character Table）展示
2. [ ] 场景表（Scene Table）展示
3. [ ] 道具表（Prop Table）展示
4. [ ] 导出 Excel 功能（4个 Sheet 页）

---

## 任务 1: 角色表实现

### 1.1 修改 HTML 文件

**文件**: `tauri-app/index.html`

**位置**: 第 497-505 行，找到 `<!-- 角色内容 -->` 部分，**完全替换**为以下内容：

```html
<!-- 角色内容 -->
<div id="character-content" class="tab-content hidden flex flex-col h-full">
    <div class="px-4 py-2 flex items-center justify-between shrink-0 bg-white">
        <div class="flex items-center gap-2">
            <h2 class="text-sm font-bold text-slate-800">角色</h2>
            <div id="character-count" class="px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded text-[9px] font-bold uppercase">0 个</div>
        </div>
    </div>
    <div class="flex-1 overflow-hidden px-6 pb-6">
        <div class="border border-border-light rounded-xl bg-white shadow-sm overflow-hidden flex flex-col h-full">
            <div class="overflow-auto custom-scrollbar h-full w-full">
                <table class="w-full text-left border-separate border-spacing-0 min-w-[1400px]">
                    <thead class="bg-slate-50 sticky top-0 z-30">
                        <tr>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[150px]">ID</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[150px]">名称</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[300px]">描述</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[300px]">生图提示词(中)</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[300px]">生图提示词(英)</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[200px]">备注</th>
                        </tr>
                    </thead>
                    <tbody id="character-tbody" class="text-xs text-slate-600">
                        <!-- 数据将动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
```

### 1.2 添加 JavaScript 代码

**文件**: `tauri-app/src/app.js`

**位置**: 在 `renderStoryboard()` 函数后面（约第 489 行后），添加以下函数：

```javascript
// 渲染角色表
function renderCharacters() {
    const characterCount = document.getElementById('character-count');
    const characterTbody = document.getElementById('character-tbody');

    characterCount.textContent = `${state.characters.length} 个`;
    characterTbody.innerHTML = '';

    if (state.characters.length === 0) {
        characterTbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-4 py-12 text-center text-slate-400">
                    <p class="mb-2">暂无角色数据</p>
                    <p class="text-xs">通过 AI 生成分镜时会自动创建角色表</p>
                </td>
            </tr>
        `;
        return;
    }

    state.characters.forEach((char, index) => {
        const row = document.createElement('tr');
        row.className = `hover-row transition-colors group cursor-pointer ${index % 2 === 0 ? 'bg-white' : 'bg-slate-50/40'}`;
        row.innerHTML = `
            <td class="px-2 py-2 font-mono text-xs text-slate-400">${char.id}</td>
            <td class="px-2 py-2 font-bold text-sm text-slate-800">${char.name || '-'}</td>
            <td class="px-2 py-2 text-xs">${char.description || '-'}</td>
            <td class="px-2 py-2 text-xs">${char.prompt_cn || '-'}</td>
            <td class="px-2 py-2 font-mono text-xs leading-tight">${char.prompt_en || '-'}</td>
            <td class="px-2 py-2 text-xs text-slate-400">${char.remarks || '-'}</td>
        `;
        row.addEventListener('click', () => showCharacterDetail(char));
        characterTbody.appendChild(row);
    });
}

// 显示角色详情
function showCharacterDetail(char) {
    // 更新标题
    document.getElementById('detail-title').textContent = '角色详情';
    document.getElementById('detail-subtitle').textContent = char.name || '未命名';

    // 更新内容
    document.getElementById('detail-description').textContent = char.description || '暂无描述';

    // 隐藏台词区域
    document.getElementById('detail-dialogue-section').classList.add('hidden');

    // 图像提示词
    document.getElementById('detail-image-prompt-zh').textContent = char.prompt_cn || '-';
    document.getElementById('detail-image-prompt-en').textContent = char.prompt_en || '-';

    // 视频提示词（角色无视频提示词，显示横线）
    document.getElementById('detail-video-prompt-zh').textContent = '-';
    document.getElementById('detail-video-prompt-en').textContent = '-';

    // 备注
    const notesSection = document.getElementById('detail-notes-section');
    if (char.remarks) {
        notesSection.classList.remove('hidden');
        document.getElementById('detail-notes').textContent = char.remarks;
    } else {
        notesSection.classList.add('hidden');
    }

    // 显示弹窗
    storyboardDetailModal.classList.remove('hidden');
}
```

### 1.3 修改 switchTab 函数

**文件**: `tauri-app/src/app.js`

**位置**: `switchTab()` 函数（约第 491-511 行），在显示对应内容部分**之后**，添加调用渲染函数：

```javascript
// 切换标签
function switchTab(tabName) {
    state.currentTab = tabName;

    // 更新标签样式
    document.querySelectorAll('[data-tab]').forEach(el => {
        const icon = el.querySelector('.tab-icon');
        const label = el.querySelector('.tab-label');
        if (el.dataset.tab === tabName) {
            icon.className = 'p-2 bg-primary rounded-lg text-white tab-icon';
            label.className = 'vertical-text text-[11px] font-bold text-primary tracking-wide tab-label';
        } else {
            icon.className = 'p-2 text-slate-400 group-hover:bg-slate-100 rounded-lg transition-all tab-icon';
            label.className = 'vertical-text text-[11px] font-bold text-slate-400 tracking-wide tab-label';
        }
    });

    // 显示对应内容
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.getElementById(`${tabName}-content`).classList.remove('hidden');

    // === 新增：渲染对应表格 ===
    if (tabName === 'character') {
        renderCharacters();
    } else if (tabName === 'scene') {
        renderScenes();
    } else if (tabName === 'prop') {
        renderProps();
    }
}
```

---

## 任务 2: 场景表实现

### 2.1 修改 HTML 文件

**文件**: `tauri-app/index.html`

**位置**: 第 507-515 行，找到 `<!-- 场景内容 -->` 部分，**完全替换**为以下内容：

```html
<!-- 场景内容 -->
<div id="scene-content" class="tab-content hidden flex flex-col h-full">
    <div class="px-4 py-2 flex items-center justify-between shrink-0 bg-white">
        <div class="flex items-center gap-2">
            <h2 class="text-sm font-bold text-slate-800">场景</h2>
            <div id="scene-count" class="px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded text-[9px] font-bold uppercase">0 个</div>
        </div>
    </div>
    <div class="flex-1 overflow-hidden px-6 pb-6">
        <div class="border border-border-light rounded-xl bg-white shadow-sm overflow-hidden flex flex-col h-full">
            <div class="overflow-auto custom-scrollbar h-full w-full">
                <table class="w-full text-left border-separate border-spacing-0 min-w-[1400px]">
                    <thead class="bg-slate-50 sticky top-0 z-30">
                        <tr>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[150px]">ID</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[150px]">名称</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[300px]">描述</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[300px]">生图提示词(中)</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[300px]">生图提示词(英)</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[200px]">备注</th>
                        </tr>
                    </thead>
                    <tbody id="scene-tbody" class="text-xs text-slate-600">
                        <!-- 数据将动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
```

### 2.2 添加 JavaScript 代码

**文件**: `tauri-app/src/app.js`

**位置**: 在 `renderCharacters()` 函数后面，添加以下函数：

```javascript
// 渲染场景表
function renderScenes() {
    const sceneCount = document.getElementById('scene-count');
    const sceneTbody = document.getElementById('scene-tbody');

    sceneCount.textContent = `${state.scenes.length} 个`;
    sceneTbody.innerHTML = '';

    if (state.scenes.length === 0) {
        sceneTbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-4 py-12 text-center text-slate-400">
                    <p class="mb-2">暂无场景数据</p>
                    <p class="text-xs">通过 AI 生成分镜时会自动创建场景表</p>
                </td>
            </tr>
        `;
        return;
    }

    state.scenes.forEach((scene, index) => {
        const row = document.createElement('tr');
        row.className = `hover-row transition-colors group cursor-pointer ${index % 2 === 0 ? 'bg-white' : 'bg-slate-50/40'}`;
        row.innerHTML = `
            <td class="px-2 py-2 font-mono text-xs text-slate-400">${scene.id}</td>
            <td class="px-2 py-2 font-bold text-sm text-slate-800">${scene.name || '-'}</td>
            <td class="px-2 py-2 text-xs">${scene.description || '-'}</td>
            <td class="px-2 py-2 text-xs">${scene.prompt_cn || '-'}</td>
            <td class="px-2 py-2 font-mono text-xs leading-tight">${scene.prompt_en || '-'}</td>
            <td class="px-2 py-2 text-xs text-slate-400">${scene.remarks || '-'}</td>
        `;
        row.addEventListener('click', () => showSceneDetail(scene));
        sceneTbody.appendChild(row);
    });
}

// 显示场景详情
function showSceneDetail(scene) {
    // 更新标题
    document.getElementById('detail-title').textContent = '场景详情';
    document.getElementById('detail-subtitle').textContent = scene.name || '未命名';

    // 更新内容
    document.getElementById('detail-description').textContent = scene.description || '暂无描述';

    // 隐藏台词区域
    document.getElementById('detail-dialogue-section').classList.add('hidden');

    // 图像提示词
    document.getElementById('detail-image-prompt-zh').textContent = scene.prompt_cn || '-';
    document.getElementById('detail-image-prompt-en').textContent = scene.prompt_en || '-';

    // 视频提示词（场景无视频提示词，显示横线）
    document.getElementById('detail-video-prompt-zh').textContent = '-';
    document.getElementById('detail-video-prompt-en').textContent = '-';

    // 备注
    const notesSection = document.getElementById('detail-notes-section');
    if (scene.remarks) {
        notesSection.classList.remove('hidden');
        document.getElementById('detail-notes').textContent = scene.remarks;
    } else {
        notesSection.classList.add('hidden');
    }

    // 显示弹窗
    storyboardDetailModal.classList.remove('hidden');
}
```

---

## 任务 3: 道具表实现

### 3.1 修改 HTML 文件

**文件**: `tauri-app/index.html`

**位置**: 第 517-525 行，找到 `<!-- 道具内容 -->` 部分，**完全替换**为以下内容：

```html
<!-- 道具内容 -->
<div id="prop-content" class="tab-content hidden flex flex-col h-full">
    <div class="px-4 py-2 flex items-center justify-between shrink-0 bg-white">
        <div class="flex items-center gap-2">
            <h2 class="text-sm font-bold text-slate-800">道具</h2>
            <div id="prop-count" class="px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded text-[9px] font-bold uppercase">0 个</div>
        </div>
    </div>
    <div class="flex-1 overflow-hidden px-6 pb-6">
        <div class="border border-border-light rounded-xl bg-white shadow-sm overflow-hidden flex flex-col h-full">
            <div class="overflow-auto custom-scrollbar h-full w-full">
                <table class="w-full text-left border-separate border-spacing-0 min-w-[1400px]">
                    <thead class="bg-slate-50 sticky top-0 z-30">
                        <tr>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[150px]">ID</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[150px]">名称</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[300px]">描述</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[300px]">生图提示词(中)</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[300px]">生图提示词(英)</th>
                            <th class="px-2 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider w-[200px]">备注</th>
                        </tr>
                    </thead>
                    <tbody id="prop-tbody" class="text-xs text-slate-600">
                        <!-- 数据将动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
```

### 3.2 添加 JavaScript 代码

**文件**: `tauri-app/src/app.js`

**位置**: 在 `renderScenes()` 函数后面，添加以下函数：

```javascript
// 渲染道具表
function renderProps() {
    const propCount = document.getElementById('prop-count');
    const propTbody = document.getElementById('prop-tbody');

    propCount.textContent = `${state.props.length} 个`;
    propTbody.innerHTML = '';

    if (state.props.length === 0) {
        propTbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-4 py-12 text-center text-slate-400">
                    <p class="mb-2">暂无道具数据</p>
                    <p class="text-xs">通过 AI 生成分镜时会自动创建道具表</p>
                </td>
            </tr>
        `;
        return;
    }

    state.props.forEach((prop, index) => {
        const row = document.createElement('tr');
        row.className = `hover-row transition-colors group cursor-pointer ${index % 2 === 0 ? 'bg-white' : 'bg-slate-50/40'}`;
        row.innerHTML = `
            <td class="px-2 py-2 font-mono text-xs text-slate-400">${prop.id}</td>
            <td class="px-2 py-2 font-bold text-sm text-slate-800">${prop.name || '-'}</td>
            <td class="px-2 py-2 text-xs">${prop.description || '-'}</td>
            <td class="px-2 py-2 text-xs">${prop.prompt_cn || '-'}</td>
            <td class="px-2 py-2 font-mono text-xs leading-tight">${prop.prompt_en || '-'}</td>
            <td class="px-2 py-2 text-xs text-slate-400">${prop.remarks || '-'}</td>
        `;
        row.addEventListener('click', () => showPropDetail(prop));
        propTbody.appendChild(row);
    });
}

// 显示道具详情
function showPropDetail(prop) {
    // 更新标题
    document.getElementById('detail-title').textContent = '道具详情';
    document.getElementById('detail-subtitle').textContent = prop.name || '未命名';

    // 更新内容
    document.getElementById('detail-description').textContent = prop.description || '暂无描述';

    // 隐藏台词区域
    document.getElementById('detail-dialogue-section').classList.add('hidden');

    // 图像提示词
    document.getElementById('detail-image-prompt-zh').textContent = prop.prompt_cn || '-';
    document.getElementById('detail-image-prompt-en').textContent = prop.prompt_en || '-';

    // 视频提示词（道具无视频提示词，显示横线）
    document.getElementById('detail-video-prompt-zh').textContent = '-';
    document.getElementById('detail-video-prompt-en').textContent = '-';

    // 备注
    const notesSection = document.getElementById('detail-notes-section');
    if (prop.remarks) {
        notesSection.classList.remove('hidden');
        document.getElementById('detail-notes').textContent = prop.remarks;
    } else {
        notesSection.classList.add('hidden');
    }

    // 显示弹窗
    storyboardDetailModal.classList.remove('hidden');
}
```

---

## 任务 4: 导出 Excel 功能

### 4.1 安装依赖

在 `tauri-app` 目录下运行：

```bash
npm install xlsx
```

### 4.2 添加 Rust 后端命令（文件保存对话框）

**文件**: `tauri-app/src-tauri/src/commands.rs`

在文件末尾添加以下命令：

```rust
#[tauri::command]
fn save_excel_file(file_path: String, content: String) -> Result<(), String> {
    use std::fs;
    use std::io::Write;

    // 确保目录存在
    if let Some(parent) = std::path::Path::new(&file_path).parent() {
        fs::create_dir_all(parent).map_err(|e| e.to_string())?;
    }

    // 写入文件
    let mut file = fs::File::create(&file_path).map_err(|e| e.to_string())?;
    file.write_all(content.as_bytes()).map_err(|e| e.to_string())?;

    Ok(())
}
```

**文件**: `tauri-app/src-tauri/src/lib.rs`

在 `invoke_handler!` 宏中注册新命令：

```rust
invoke_handler![
    // ... 其他命令 ...
    save_excel_file
])
```

### 4.3 添加前端导出功能

**文件**: `tauri-app/src/app.js`

**位置**: 在文件顶部的 import 部分，添加：

```javascript
import { invoke } from '@tauri-apps/api/core';
import { save } from '@tauri-apps/api/dialog';
import * as XLSX from 'xlsx';
```

**位置**: 在 `setupEventListeners()` 函数中（约第 59 行），添加导出按钮事件监听：

```javascript
// 导出 Excel 按钮
document.getElementById('export-excel-btn').addEventListener('click', handleExportExcel);
```

**位置**: 在文件中添加导出函数：

```javascript
// 导出 Excel
async function handleExportExcel() {
    if (!state.currentProject) {
        alert('请先打开一个项目');
        return;
    }

    // 检查是否有数据
    if (state.storyboards.length === 0 && state.characters.length === 0 &&
        state.scenes.length === 0 && state.props.length === 0) {
        alert('当前项目没有数据可导出');
        return;
    }

    try {
        // 获取项目名称
        const projectName = projectTitle.textContent || '分镜项目';

        // 创建工作簿
        const workbook = XLSX.utils.book_new();

        // 分镜表
        if (state.storyboards.length > 0) {
            const storyboardData = state.storyboards.map(sb => ({
                '序号': sb.sequence_number,
                '镜号': sb.mirror_id,
                '镜头类型': sb.shot_type || '',
                '景别': sb.shot_size || '',
                '时长': sb.duration || '',
                '对白/旁白': sb.dialogue || '',
                '画面描述': sb.description || '',
                '备注': sb.notes || '',
                '生图提示词-首帧(中)': sb.image_prompt_zh || '',
                '生图提示词-首帧(英)': sb.image_prompt_en || '',
                '生图提示词-尾帧(中)': sb.image_prompt_tail_zh || '',
                '生图提示词-尾帧(英)': sb.image_prompt_tail_en || '',
                '生视频提示词(中)': sb.video_prompt_zh || '',
                '生视频提示词(英)': sb.video_prompt_en || ''
            }));
            const worksheet = XLSX.utils.json_to_sheet(storyboardData);
            XLSX.utils.book_append_sheet(workbook, worksheet, '分镜表');
        }

        // 角色表
        if (state.characters.length > 0) {
            const characterData = state.characters.map(char => ({
                'ID': char.id,
                '名称': char.name || '',
                '描述': char.description || '',
                '生图提示词(中)': char.prompt_cn || '',
                '生图提示词(英)': char.prompt_en || '',
                '备注': char.remarks || ''
            }));
            const worksheet = XLSX.utils.json_to_sheet(characterData);
            XLSX.utils.book_append_sheet(workbook, worksheet, '角色');
        }

        // 场景表
        if (state.scenes.length > 0) {
            const sceneData = state.scenes.map(scene => ({
                'ID': scene.id,
                '名称': scene.name || '',
                '描述': scene.description || '',
                '生图提示词(中)': scene.prompt_cn || '',
                '生图提示词(英)': scene.prompt_en || '',
                '备注': scene.remarks || ''
            }));
            const worksheet = XLSX.utils.json_to_sheet(sceneData);
            XLSX.utils.book_append_sheet(workbook, worksheet, '场景');
        }

        // 道具表
        if (state.props.length > 0) {
            const propData = state.props.map(prop => ({
                'ID': prop.id,
                '名称': prop.name || '',
                '描述': prop.description || '',
                '生图提示词(中)': prop.prompt_cn || '',
                '生图提示词(英)': prop.prompt_en || '',
                '备注': prop.remarks || ''
            }));
            const worksheet = XLSX.utils.json_to_sheet(propData);
            XLSX.utils.book_append_sheet(workbook, worksheet, '道具');
        }

        // 生成文件
        XLSX.writeFile(workbook, `${projectName}.xlsx`);

        // 显示成功提示
        addChatMessage('assistant', `✅ 导出成功！已保存到 ${projectName}.xlsx`);

    } catch (error) {
        console.error('导出 Excel 失败:', error);
        alert('导出 Excel 失败: ' + error);
    }
}
```

### 4.4 修改 HTML 添加导出按钮

**文件**: `tauri-app/index.html`

**位置**: 第 459-464 行，找到导出按钮，添加 id：

```html
<button id="export-excel-btn" class="bg-white border border-slate-200 hover:bg-slate-50 px-2 py-1 rounded text-xs font-medium flex items-center gap-1 transition-colors">
    <span class="material-symbols-outlined text-[14px]">ios_share</span>
    导出
</button>
```

---

## 数据结构参考

### state.characters
```javascript
{
    id: "uuid-string",
    name: "角色名称",
    description: "角色描述",
    prompt_cn: "生图提示词中文",
    prompt_en: "生图提示词英文",
    remarks: "备注"
}
```

### state.scenes
```javascript
{
    id: "uuid-string",
    name: "场景名称",
    description: "场景描述",
    prompt_cn: "生图提示词中文",
    prompt_en: "生图提示词英文",
    remarks: "备注"
}
```

### state.props
```javascript
{
    id: "uuid-string",
    name: "道具名称",
    description: "道具描述",
    prompt_cn: "生图提示词中文",
    prompt_en: "生图提示词英文",
    remarks: "备注"
}
```

---

## 验收标准

### 角色/场景/道具表
- [ ] 表格正确显示数据
- [ ] 空状态显示正确（无数据时的提示）
- [ ] 数量统计正确显示
- [ ] 点击行显示详情弹窗
- [ ] 切换标签正确渲染对应表格

### 导出 Excel
- [ ] 点击导出按钮生成 Excel 文件
- [ ] Excel 包含 4 个 Sheet 页（分镜表、角色、场景、道具）
- [ ] 每个 Sheet 的数据正确
- [ ] 文件名为项目名称

---

## 注意事项

1. **代码风格**: 保持与现有代码一致，参考 `renderStoryboard()` 的实现模式
2. **复用组件**: 详情弹窗复用现有的 `#storyboard-detail-modal`
3. **测试数据**: 可以通过 AI 生成分镜来测试，数据库中已有完整的数据结构
4. **分步实现**: 建议先完成角色表，测试通过后再实现场景表和道具表

---

*文档版本: 1.0*
*创建时间: 2026-02-13*
